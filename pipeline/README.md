# SWB covid pipeline

This pipeline is built using luigi to schedule and organize tasks.

With luigi we are capable of declaring dependencies and use different sources
for our data.

Right now we use the `luigi.contrib.dropbox` package to store our outputs.

An output is the final target of a task, in our case is a file uploaded to dropbox.

## Environments

We only have one required environment variable for this pipeline

- `SWB_DROPBOX_TOKEN`, which should be the API token for a dropbox app that won't expire. 

## Workflows

We currently have to different workflows on for scrapping the mumbai wards pdf
and other to calculate metrics from the covid19india.org API.

### Running scrapping tasks

```sh
poetry run python -m luigi --module pipeline.tasks.stopcoronavirus_mcgm_scrapping ExtractDataFromPdfDashboardWrapper --local-scheduler
```

### Running tasks to calculate metrics from covid19india.org API

```sh
poetry run python -m luigi --module pipeline.tasks.cities_metrics CalculateMetricsTask --city-name 'Mumbai' --states-and-districts '{"MH": ["Mumbai"]}'  --local-scheduler
```

### Running all tasks

```sh
python -m luigi --module pipeline.tasks SWBPipelineWrapper  --states-and-districts '{ "MH": ["Mumbai", "Pune", "Nanded", "Raigad"], "UP": ["Agra"]  }' --date 2020-09-20 --start-date 2020-04-20
```


## Tasks

### SWBPipelineWrapper

Accepts the following parameters:

- `--date`: DateParameter, The date for which the task should run.
- `--start-date`: DateParameter, The start date for the calculate metrics script.
- `--states-and-districts`: DictParameter, a json object with the state and districts to get metrics for.
- `--elderly-page`: IntParameter, the page number for the elderly numbers page for the [stopcoronavirus mcgm pdf](http://stopcoronavirus.mcgm.gov.in/assets/docs/Dashboard.pdf).
- `--daily-case-growth-page`: IntParameter, the page number for the daily grow rate in the coronavirus mcgm pdf.
- `--positive-breakdown-index`: IntParameter, the page index for the positive breakdown of cases in the cornoavirus mcgm pdf.

It's just a wrapper for the following tasks:

- `CalculateCityMetricsTask`
- `ExtractDataFromPdfDashboardWrapper`

### CalculateCityMetricsTask

Executes the `calculate_metrics.py` script by [saurabhmj](https://github.com/saurabhmj) which fetchs values from the [covid19india](https://www.covid19india.org/) v4 API and calculate metrics for a given set of states and districts.

#### Accepts the following parameters:

##### `--date`

`DateParameter`, The date for which the task will run, defaults to `datetime.date.today()`.

It's usually mainly to define the ouput path.


##### `--start-date`

`DateParameter`, The start date for the calculate metrics script.

Doesn't defaults to anything, but a "past" date is recommended `"2020-04-20"`

##### `--states-and-districts`: 

DictParameter, a json object with the state and districts to get metrics for.

Doesn't defaults to anything, but the value can be defined as:

```
'{ "MH": ["Mumbai", "Pune", "Nanded", "Raigad"], "UP": ["Agra"]  }'
```

It Should be a string with a json dictionary of the states (keys) and the districts (string array) to get data from.

The output result is defined by a hash generated by the states and districts object.

Which means that if you run the task twice with different values in this parameter for the same `--date` you should have two different ouputs.

#### Outputs

##### `/data/hospitalizations/hospitalizations-city-metrics.csv`

This file should get overwritten between runs, holds the hospitalizations numbers used to calculate metrics.

##### `/data/city-metrics/{state_districts_hash(self.states_and_districts)}-{self.date}-city-metrics.csv`

A file containing the metrics calculated for that date.

### `ExtractDataFromPdfDashboardWrapper`

This tasks grabs the [mcgt dashboard pdf](http://stopcoronavirus.mcgm.gov.in/assets/docs/Dashboard.pdf) and scrap ward data for the wards in the district of mumbai.

#### Accepts the following parameters:

##### `--date`

A DateParameter, defaults to `datetime.date.now()` defines the for the file names.
Shouldn't be changed, since we cannot download PDFs for past dates.

##### `--elderly-page`

An IntParameter, defaults to `22`.

It may change between tasks, so it may need to be tweaked from time to time.

##### `--daily-case-growth-page`

An IntParameter, defaults to `25`


It may change between tasks, so it may need to be tweaked from time to time.

##### `--positive-breakdown-index`

An IntParameter, defaults to `22`.

Because for this script we are using `pdfplumber`, the page count starts at `0`.

It may change between tasks, so it may need to be tweaked from time to time.

#### Outputs:

##### `/data/dashboard-pdf/{self.date}-mcgm.stopcoronavirus.pdf`

The PDF downloaded by the task.

Because luigi tasks are idempotent, if the pdf exists for any given date it will not try to downloaded it again.

##### `/data/positive-wards/ward-positive-breakdown-{self.date}.csv`

The breakdown positive of positive cases scrapped from the pdf for a given date.

##### `/data/dashboard-case-growth/growth-{self.date}.csv`

Numbers for the daily growth scrapped from the pdf.

##### `/data/dashboard-elderly/elderly-{self.date}.csv`

The table of elderly cases scrapped from the pdf.